<style>*{margin:0}#c{image-rendering:pixelated;width:100%;height:100%;}</style><canvas id="c" width="360" height="400"><script>(()=>{let{sin:b,cos:c,floor:a,random:d,sqrt:e,ceil:f,min:g,max:h,abs:j}=Math;const i=8,k=90,l=100,n=32,m=.1,o=7,p=30,q={x:.52,y:-.4},r=()=>({dir:{x:.61,y:.79},life:100}),s={r:24,g:200,b:170},t={r:255,g:255,b:14},u=120,v=a=>a.match(/.{1,8}/g).map(a=>a.split("").map(a=>parseInt(a,10))),w=v("0000000001100110011001100000000000111100011111100110011000000000"),x={e1:v("0000000000011000001111000010010000111100010010100101101010010101"),e2:v("0000000000000000001001000111111000011000001111000000000000000000"),b:v("0000000000000000000000000000000000000000000110000001100000011000")};let y={87:"up",83:"down",65:"left",68:"right",32:"shoot",191:"debug"},z={up:!1,down:!1,left:!1,right:!1,shoot:!1,debug:!1,rotate:0};document.addEventListener("mousemove",a=>{z.rotate=a.movementX}),document.addEventListener("mousedown",a=>{z.shoot=0===a.button}),document.addEventListener("mouseup",()=>{z.shoot=!1}),document.addEventListener("keydown",a=>{z[y[a.keyCode]]=!0}),document.addEventListener("keyup",a=>{z[y[a.keyCode]]=!1});let A=new AudioContext,B=null,C=document.getElementById("c"),D=C.getContext("2d");D.imageSmoothingEnabled=!1,C.onclick=()=>C.requestPointerLock();const E=document.createElement("canvas");E.width=k,E.height=l;const F=E.getContext("2d");let G=o,H=120,I=!1,J=u,K=!1,L=0,M=null,N=0,O=0,P=[],Q=[],R=r(),S={...q};const T=(a,b,c=0)=>{for(let d=c;d<a;d++)b(d)},U=(a,b)=>{const c=[];for(let d=a;d<=b;d++)c.push(d);return c},V=a=>Array(a).fill([]).map(()=>Array(a).fill(0)),W=b=>{for(let c=b.length-1;0<c;c--){const e=a(d()*(c+1));[b[c],b[e]]=[b[e],b[c]]}},X=(a,b)=>0===M[0|a][0|b],Y=(c,a)=>e((a.x-c.x)**2+(a.y-c.y)**2),Z=(c,a)=>({x:c.x+a.x,y:c.y+a.y}),$=(b,a)=>({x:b.x*a,y:b.y*a}),_=(c,a)=>Z(c,$(a,-1)),aa=(b,a)=>({x:b.x/a,y:b.y/a}),ba=b=>e(b.x**2+b.y**2),ca=b=>aa(b,ba(b)),da=(d,a)=>{let e=c(a),f=b(a);return{x:d.x*e-d.y*f,y:d.x*f+d.y*e}},ea=(a,b)=>ca(_(b,a)),fa=a=>`rgb(${a.r},${a.g},${a.b})`,ga=(a,b)=>({r:a.r*b,g:a.g*b,b:a.b*b}),ha=(a,b)=>d()*(b-a)+a,ia=(b,c)=>(b=f(b),c=a(c),a(d()*(c-b+1))+b),ja=()=>ca({x:ha(-1,1),y:ha(-1,1)}),ka=()=>ia(120,360),la=a=>{if(0<H||10<Y(a.pos,R.pos))return!1;let b=ea(a.pos,R.pos),c={...a.pos},d=!1;for(;;){if(.5>=Y(c,R.pos)){d=!0;break}if(!X(c.x,c.y))break;c=Z(c,b)}return d},ma=a=>{const d=R.dir.x;R.dir.x=R.dir.x*c(a)-R.dir.y*b(a),R.dir.y=d*b(a)+R.dir.y*c(a);const e=S.x;S.x=S.x*c(a)-S.y*b(a),S.y=e*b(a)+S.y*c(a)},na=(a,b,c)=>{Q.push({sprite:"b",pos:{...a},dir:{...b},lifetime:180,ownerPlayer:c})},oa=a=>{const b=A.createOscillator(),c=A.createGain();b.type="triangle",b.frequency.value=ia(90,92),b.connect(c),c.connect(A.destination),c.gain.setValueAtTime(a,A.currentTime),c.gain.setTargetAtTime(0,A.currentTime,.015),b.start()},pa=24,qa=2*pa,ra={};((a,b)=>{U(32,126).map(b=>String.fromCharCode(b)).forEach(d=>{const e=document.createElement("canvas");e.width=qa,e.height=qa;const c=e.getContext("2d");c.font=`${pa}px monospace`,c.fillStyle=a,c.fillText(d,0,pa);const f=c.getImageData(0,0,qa,qa).data;for(let a=0;a<f.length;a+=4)if(0!==f[a]||0!==f[a+1]||0!==f[a+2]){const b=0|a/4;c.fillRect(0|b%qa,0|b/qa,1,1)}b[d]=e})})("white",ra);const sa=(a,b,c,d=ra)=>{a.split("").forEach((a,e)=>{D.drawImage(d[a],b+e*(pa-10),c)})},ta=()=>{const a=()=>{let a=V(n);const b=(b,c)=>{let d=0;return[-1,0,1].forEach(e=>{[-1,0,1].forEach(f=>{if(0===e&&0===f)return;let g=b+e,h=c+f;(0>g||0>h||g>=n||h>=n||a[g][h])&&d++})}),d};return T(n,b=>{T(n,c=>{a[c][b]=d()<.49?1:0})}),T(10,()=>{let c=V(n);T(n,d=>{T(n,e=>{let f=b(e,d);c[e][d]=a[e][d]?f<4?0:1:f>5?1:0})}),a=c}),a[0]=Array(n).fill(1),a[n-1]=Array(n).fill(1),a.forEach(a=>{a[0]=1,a[n-1]=1}),a};let b=a();for(;0!==b[n/2][n/2];)b=a();(a=>{const b=V(n),c=[];b[n/2][n/2]=1,c.push({x:n/2,y:n/2});for(const d=({x:d,y:e})=>{[-1,0,1].forEach(f=>{[-1,0,1].forEach(g=>{if(0!==f&&0!==g)return;let h=d+f,i=e+g;0<=h&&0<=i&&h<n&&i<n&&0===a[h][i]&&0===b[h][i]&&(b[h][i]=1,c.push({x:h,y:i}))})})};c.length;)d(c.shift());T(n,c=>{T(n,d=>{0===a[d][c]&&0===b[d][c]&&(a[d][c]=1)})})})(b);let c=[],e=!1;T(n,a=>{T(n,d=>{0===b[d][a]&&(e?c.push({x:d,y:a}):(R.pos={x:d+.1,y:a+.1},e=!0))},1)},1),W(c);const f=()=>{let a=c.pop();for(;15>=Y(a,R.pos);)a=c.pop();return a};return T(10,()=>{P.push({sprite:"e1",pos:f(),dir:ja(),changeDirTimer:ka(),life:100,shootingFrameTimeout:p})}),T(10,()=>{P.push({sprite:"e2",pos:f(),dir:ja(),changeDirTimer:ka(),life:50,shootingFrameTimeout:p})}),b};let ua=()=>{if(z.debug&&(window.DEBUG=!0),K||(D.fillStyle="black",D.fillRect(0,0,360,400)),B(),window.DEBUG){const a={},b=D.getImageData(0,0,360,400).data;for(let c=0;c<b.length;c+=4){const d=fa({r:b[c],g:b[c+1],b:b[c+2]});if(255!==b[c+3])throw new Error("Alpha is not 255!");a[d]=!0}let c=Object.keys(a).length,d=32<c?"error":"log";console[d](`Distinct colors in frame: ${c}`)}z.rotate=0,window.DEBUG=!1,window.requestAnimationFrame(ua)};const va=a=>()=>{K=!0,D.fillStyle=fa(s);for(let a=0;400>a;a+=40)D.fillRect(0,a,L,20);for(let a=20;400>a;a+=40)D.fillRect(360-L,a,L,20);L+=5,360<L&&setTimeout(()=>{K=!1,L=0,B=a},600)};let wa=()=>{F.fillStyle="black",F.fillRect(0,0,k,l),P.forEach(a=>{if(a.hit=!1,a.shootingFrameTimeout--,a.changeDirTimer--,0>=a.changeDirTimer&&(a.dir=ja(),a.changeDirTimer=ka()),P.forEach(b=>{b===a||.5>=Y(a.pos,b.pos)&&(a.dir=$(a.dir,-1))}),la(a,R)){let b=ea(a.pos,R.pos);if(a.dir=b,"e1"===a.sprite){let c=Y(R.pos,a.pos);if(3>=c&&(a.dir=$(ca(ea(a.pos,R.pos)),-3)),0>=a.shootingFrameTimeout){let d=da(b,ha(-.2,.2));na(a.pos,d,!1),a.shootingFrameTimeout=p,oa(1/h(c,1))}}.5>=Y(a.pos,R.pos)&&(a.life=0,R.life-=5)}let b=()=>Z(a.pos,$(a.dir,"e1"===a.sprite?.02:.12)),c=b();X(c.x,c.y)?a.pos=c:(a.dir=$(a.dir,-1),a.pos=b())}),Q.forEach(a=>{let b=Z(a.pos,$(a.dir,.5));if(X(b.x,b.y))a.pos=b;else return void(a.lifetime=0);P.forEach(b=>{if(a.ownerPlayer&&.5>Y(a.pos,b.pos)){b.life-=15,b.hit=!0,N+=15;let c=_(b.pos,$(a.dir,-.4)),d=!0;P.forEach(a=>{b===a||.5>=Y(c,a.pos)&&(d=!1)}),X(c.x,c.y)||(d=!1),d&&(b.pos=c),a.lifetime=0}}),!a.ownerPlayer&&0<a.lifetime&&.5>=Y(a.pos,R.pos)&&(R.life-=2)});const b=[],c=[];for(let c=0;c<k;c++){const d=2*c/k-1,e=R.dir.x+S.x*d,f=R.dir.y+S.y*d;let h,m,n=0|R.pos.x,o=0|R.pos.y;const p=j(1/e),q=j(1/f);let r,t,u,v,x=!1;for(0>e?(t=-1,h=(R.pos.x-n)*p):(t=1,h=(n+1-R.pos.x)*p),0>f?(u=-1,m=(R.pos.y-o)*q):(u=1,m=(o+1-R.pos.y)*q);!x;)h<m?(h+=p,n+=t,v=0):(m+=q,o+=u,v=1),0<M[n][o]&&(x=!0);r=0===v?(n-R.pos.x+(1-t)/2)/e:(o-R.pos.y+(1-u)/2)/f;const z=0|l/r;let A=-z/2+l/2;0>A&&(A=0);let B=z/2+l/2;B>=l&&(B=l-1),A|=0,B|=0;let y;y=0===v?R.pos.y+r*f:R.pos.x+r*e,y-=a(y);let C=0|y*i;0===v&&0<e&&(C=i-C-1),1===v&&0>f&&(C=i-C-1);let D=(B-A)/l,E=g((0|10*D)/10+.1,1);for(let a=A;a<B;a++){let b=256*a-128*l+128*z,d=0|b*i/z/256;if(!w[d])continue;let e=g(1,w[d][C]+.5),f=ga(s,E*e);F.fillStyle=fa(f),F.fillRect(c,a,1,1)}b[c]=r}const d=[].concat(P,Q);for(let a=0;a<d.length;a++)c[a]={order:a,distance:(R.pos.x-d[a].pos.x)*(R.pos.x-d[a].pos.x)+(R.pos.y-d[a].pos.y)*(R.pos.y-d[a].pos.y)};c.sort((c,a)=>a.distance-c.distance);for(let a=0;a<d.length;a++){let e=d[c[a].order],f=x[e.sprite],h=e.pos.x-R.pos.x,m=e.pos.y-R.pos.y,n=1/(S.x*R.dir.y-R.dir.x*S.y),o=n*(R.dir.y*h-R.dir.x*m),p=n*(-S.y*h+S.x*m),q=0|k/2*(1+o/p);let r=0|8/p,s=0|j(0|l/p)/2,u=(0|-s/2+l/2)+r;0>u&&(u=0);let v=(0|s/2+l/2)+r;v>=l&&(v=l-1);let w=0|j(0|l/p)/2,y=0|-w/2+q;0>y&&(y=0);let z=0|w/2+q;z>=k&&(z=k-1);let A=(v-u)/l,B=g(1,(0|10*A)/10+.4),C=ga(t,B);F.fillStyle=e.hit?"white":fa(C);for(let a,c=y;c<z;c++)if(a=0|(0|256*(c-(-w/2+q))*i/w)/256,0<p&&0<c&&c<k&&p<b[c])for(let b=u;b<v;b++){let e=256*(b-r)-128*l+128*s,d=0|e*i/s/256;f[d]&&1===f[d][a]&&F.fillRect(c,b,1,1)}}const e=z.shoot&&0>=G,f=e?ia(-2,2):0,n=e?ia(-2,2):0;D.drawImage(E,f,n,360,400),D.fillStyle=fa(t);const q=0|100*(R.life/100);D.fillRect(10,10,q,10);let r=$(R.dir,m);if(z.up){let a=Z(R.pos,r);X(a.x,R.pos.y)&&(R.pos.x=a.x),X(R.pos.x,a.y)&&(R.pos.y=a.y)}if(z.down){let a=_(R.pos,r);X(a.x,R.pos.y)&&(R.pos.x=a.x),X(R.pos.x,a.y)&&(R.pos.y=a.y)}let u=$({x:-1*R.dir.y,y:R.dir.x},.5*m);if(z.right){let a=_(R.pos,u);X(a.x,R.pos.y)&&(R.pos.x=a.x),X(R.pos.x,a.y)&&(R.pos.y=a.y)}if(z.left){let a=Z(R.pos,u);X(a.x,R.pos.y)&&(R.pos.x=a.x),X(R.pos.x,a.y)&&(R.pos.y=a.y)}let v=.15*(-z.rotate*.03);ma(v),e&&(na(R.pos,R.dir,!0),G=o,oa(.75)),G--,H--,Q=Q.map(a=>({...a,lifetime:a.lifetime-1})).filter(a=>0<a.lifetime),P=P.filter(a=>0<a.life),0>=P.length&&setTimeout(()=>{B=va(xa)},2e3),0>=R.life&&(B=va(ya))},xa=()=>{if(!I){R=r(),S={...q},M=ta(),O++;const a=localStorage.getItem("hs");(N>a||!a)&&localStorage.setItem("hs",N),I=!0}const a=localStorage.getItem("hs");sa("31337 game",10,100),sa(`Score: ${N}`,20,128),sa(`High score: ${a}`,20,152),0>=J&&(sa("Press FIRE to continue",10,300),z.shoot&&(I=!1,J=u,B=va(wa))),J--},ya=()=>{sa("Game over",10,10),sa(`Your score is ${N}`,10,100);const a=O-1;sa(`You've cleared ${a} floor${1==a?"":"s"}`,10,130),0>=J&&(sa("Press FIRE to continue",10,300),z.shoot&&(J=u,B=va(xa))),J--};B=xa,ua()})();</script>