<style>*{margin:0}#c{image-rendering:pixelated;width:100%;height:100%;}</style><canvas id="c" width="360" height="400"><script>(()=>{let{sin:b,cos:c,floor:a,random:d,sqrt:e,ceil:f,min:g,max:h,abs:j}=Math,k=16,l=90,m=100,n=32,i=.1,o=10,p=7,q=30,r=4,s=30,t={x:.52,y:-.4},u=()=>({dir:{x:.61,y:.79},life:100,gunHeat:o,gunHeatBlock:0}),v=100,w=a=>a.map(a=>parseInt(a,16).toString(2).substr(1).split("")),z=[w(["10000","11ff8","13ffc","17ffe","1700e","1700e","1700e","1700e","1700e","1700e","1700e","1700e","17ffe","13ffc","11ff8","10000"]),w(["10000","1011e","111b7","13d27","11c3f","10e3f","1661e","13000","11000","10000","17ffe","1c7ff","1c7ff","1ffff","17ffe","10000"]),w(["1383c","17c7e","14c4e","14c4e","14c7e","17c7e","17c7e","17c7e","17c3c","17c00","17c3c","17c7e","17c6e","17c5e","17c7e","1383c"])],x={e1:w(["10000","10000","103c0","103c0","10ff0","10ff0","10c30","10c30","10ff0","10ff0","130cc","130cc","133cc","133cc","1c333","1c333"]),e2:w(["10000","10000","10000","10000","10c30","10c30","13ffc","13ffc","103c0","103c0","10ff0","10ff0","10000","10000","10000","10000"]),b:w(["10000","10000","10000","10000","10000","10000","10000","10000","10000","10000","103c0","103c0","103c0","103c0","103c0","103c0"]),m:w(["10000","10000","10000","10000","10000","10000","10000","10000","10ff0","11e78","11e78","11818","11818","11e78","11e78","10ff0"])},y={87:"up",83:"down",65:"left",68:"right",32:"shoot",70:"special",191:"debug"},A={up:0,down:0,left:0,right:0,shoot:0,special:0,debug:0,rotate:0},B=document.addEventListener;B("mousemove",a=>{A.rotate=a.movementX}),B("mousedown",a=>{A.shoot=0===a.button}),B("mouseup",()=>{A.shoot=0}),B("keydown",a=>{A[y[a.keyCode]]=1}),B("keyup",a=>{A[y[a.keyCode]]=0});let C=new AudioContext,D=null,E=document.getElementById("c"),F=E.getContext("2d");F.imageSmoothingEnabled=0,E.onclick=()=>E.requestPointerLock();let G=document.createElement("canvas");G.width=G.height=l;let H,I,J=G.getContext("2d"),K=p,L=120,M=0,N=v,O=0,P=0,Q=null,R=0,S=0,T=[],U=[],V=[],W=u(),X=0,Y=0,Z=s,$={...t},_=(a,b,c=0)=>{for(let d=c;d<a;d++)b(d)},aa=(a,b)=>{let c=[];for(let d=a;d<=b;d++)c.push(d);return c},ba=a=>Array(a).fill([]).map(()=>Array(a).fill(0)),ca=b=>{for(let c,e=b.length-1;0<e;e--)c=a(d()*(e+1)),[b[e],b[c]]=[b[c],b[e]]},da=(a,b)=>0===Q[0|a][0|b],ea=(c,a)=>e((a.x-c.x)**2+(a.y-c.y)**2),fa=(c,a)=>({x:c.x+a.x,y:c.y+a.y}),ga=(b,a)=>({x:b.x*a,y:b.y*a}),ha=(c,a)=>fa(c,ga(a,-1)),ia=(b,a)=>({x:b.x/a,y:b.y/a}),ja=b=>e(b.x**2+b.y**2),ka=b=>ia(b,ja(b)),la=(d,a)=>{let e=c(a),f=b(a);return{x:d.x*e-d.y*f,y:d.x*f+d.y*e}},ma=(a,b)=>ka(ha(b,a)),na=a=>`rgb(${a.r},${a.g},${a.b})`,oa=(a,b)=>({r:a.r*b,g:a.g*b,b:a.b*b}),pa=a=>({r:-a.r+255,g:-a.g+255,b:-a.b+255}),qa=a=>oa(a,.5),ra=(a,b,c,d,e)=>{e.fillRect(a,b,c,1),e.fillRect(a,b+d,c,1),e.fillRect(a,b,1,d),e.fillRect(a+c,b,1,d)},sa=(a,b)=>d()*(b-a)+a,ta=(b,c)=>(b=f(b),c=a(c),a(d()*(c-b+1))+b),ua=()=>ka({x:sa(-1,1),y:sa(-1,1)}),va=()=>ta(120,360),wa=(a,b)=>{if(!b&&(a.blind||0<L||10<ea(a.pos,W.pos)))return 0;let c=ma(a.pos,W.pos),d={...a.pos},e=0;for(;;){if(.5>=ea(d,W.pos)){e=1;break}if(!da(d.x,d.y))break;d=fa(d,c)}return e},xa=a=>{let d=W.dir.x;W.dir.x=W.dir.x*c(a)-W.dir.y*b(a),W.dir.y=d*b(a)+W.dir.y*c(a);let e=$.x;$.x=$.x*c(a)-$.y*b(a),$.y=e*b(a)+$.y*c(a)},ya=(a,b,c,d)=>{U.push({sprite:"b",pos:{...a},dir:la(b,sa(-d,d)),lifetime:180,ownerPlayer:c})},za=(a,b)=>{T.push({sprite:a,pos:b,dir:ua(),changeDirTimer:va(),life:100,shootingFrameTimeout:q})},Aa=a=>{V.push({sprite:"m",pos:a})},Ba=a=>{let b=C.createOscillator(),c=C.createGain();b.type="triangle",b.frequency.value=ta(90,92),b.connect(c),c.connect(C.destination),c.gain.setValueAtTime(a,C.currentTime),c.gain.setTargetAtTime(0,C.currentTime,.015),b.start()},Ca=()=>{H={r:ta(30,255),g:ta(30,255),b:ta(30,255)},I=pa(H)};Ca();let Da=24,Ea=48,Fa={},Ga={},Ha=(a,b)=>{aa(32,126).map(b=>String.fromCharCode(b)).forEach(d=>{let e=document.createElement("canvas");e.width=Ea,e.height=Ea;let c=e.getContext("2d");c.font=`${Da}px monospace`,c.fillStyle=a,c.fillText(d,0,Da);let f=c.getImageData(0,0,Ea,Ea).data;for(let a=0;a<f.length;a+=4)if(0!==f[a]||0!==f[a+1]||0!==f[a+2]){let b=0|a/4;c.fillRect(0|b%Ea,0|b/Ea,1,1)}b[d]=e})},Ia=()=>{Ha(na(H),Fa),Ha(na(I),Ga)};Ia();let Ja=(a,b,c,d)=>{a.split("").forEach((a,e)=>{F.drawImage(d[a],b+e*14,c)})},Ka=(a,b,c)=>{_(ta(2,4),()=>{let d=ta(-2,2),e=ta(-2,2);Ja(a,b+d,c+e,Ga)}),Ja(a,b,c,Fa)},La=()=>{let a=()=>{let a=ba(n),b=(b,c)=>{let d=0;return[-1,0,1].forEach(e=>{[-1,0,1].forEach(f=>{if(0===e&&0===f)return;let g=b+e,h=c+f;(0>g||0>h||g>=n||h>=n||a[g][h])&&d++})}),d};return _(n,b=>{_(n,c=>{a[c][b]=d()<.49?1:0})}),_(10,()=>{let c=ba(n);_(n,d=>{_(n,e=>{let f=b(e,d);c[e][d]=a[e][d]?f<4?0:1:f>5?1:0})}),a=c}),a[0]=Array(n).fill(1),a[n-1]=Array(n).fill(1),a.forEach(a=>{a[0]=1,a[n-1]=1}),a},b=a();for(;0!==b[n/2][n/2];)b=a();(a=>{let b=ba(n),c=[];b[n/2][n/2]=1,c.push({x:n/2,y:n/2});for(let d=({x:d,y:e})=>{[-1,0,1].forEach(f=>{[-1,0,1].forEach(g=>{if(0!==f&&0!==g)return;let h=d+f,i=e+g;0<=h&&0<=i&&h<n&&i<n&&0===a[h][i]&&0===b[h][i]&&(b[h][i]=1,c.push({x:h,y:i}))})})};c.length;)d(c.shift());_(n,c=>{_(n,d=>{0===a[d][c]&&0===b[d][c]&&(a[d][c]=1)})})})(b),_(n,a=>{_(n,c=>{b[c][a]&&(b[c][a]=ta(1,z.length))})});let c=[],e=0;_(n,a=>{_(n,d=>{0===b[d][a]&&(e?c.push({x:d,y:a}):(W.pos={x:d+.1,y:a+.1},e=1))},1)},1),ca(c);let f=()=>{let a=c.pop();for(;15>=ea(a,W.pos);)a=c.pop();return a};return _(3<S?1:0,()=>{let a=c.pop();Aa(a)}),_(g(20,ta(1*(S||1),5*(S||1))),()=>za("e1",f())),_(g(5,S),()=>za("e2",f())),b};{let a=document.createElement("canvas");a.id="minimap",a.width=32,a.height=32,a.style.position="absolute",a.style.width="256px",a.style["image-rendering"]="pixelated",document.body.insertBefore(a,document.body.firstChild),window.minimap=a}let Ma=()=>{if(A.debug&&(window.DEBUG=1),O||(F.fillStyle="black",F.fillRect(0,0,360,400)),D(),window.DEBUG){let a={},b=F.getImageData(0,0,360,400).data;for(let c,d=0;d<b.length;d+=4){if(c=na({r:b[d],g:b[d+1],b:b[d+2]}),255!==b[d+3])throw new Error("Alpha is not 255!");a[c]=1}let c=Object.keys(a).length,d=32<c?"error":"log";console[d](`Distinct colors in frame: ${c}`)}A.rotate=0,window.DEBUG=0,window.requestAnimationFrame(Ma)},Na=a=>()=>{O=1,F.fillStyle=na(H);for(let a=0;400>a;a+=40)F.fillRect(0,a,P,20);for(let a=20;400>a;a+=40)F.fillRect(360-P,a,P,20);P+=5,360<P&&setTimeout(()=>{O=0,P=0,D=a},500)},Oa=()=>{let{minimap:b}=window,c=b.getContext("2d");c.imageSmoothingEnabled=0,b.style.display=window.DEBUG_minimap?"block":"none",J.fillStyle="black",J.fillRect(0,0,l,m),c.fillStyle="black",c.fillRect(0,0,n,n);let d=A.shoot&&(Y||0>=K)&&!W.gunHeatBlock;T.forEach(a=>{if(a.hit=0,a.shootingFrameTimeout--,a.changeDirTimer--,0>=a.changeDirTimer&&(a.dir=ua(),a.changeDirTimer=va()),"e1"===a.sprite&&T.forEach(b=>{b===a||.5>=ea(a.pos,b.pos)&&(a.dir=ga(a.dir,-1))}),wa(a,d)){let b=ma(a.pos,W.pos);if(a.dir=b,"e1"===a.sprite){let c=ea(W.pos,a.pos);3>=c&&(a.dir=ga(ka(ma(a.pos,W.pos)),-3)),0>=a.shootingFrameTimeout&&(ya(a.pos,b,0,.2),a.shootingFrameTimeout=q,Ba(1/h(c,1)))}.5>=ea(a.pos,W.pos)&&("e1"===a.sprite?a.life=0:(a.dir=ga(a.dir,-1),a.blind=1,setTimeout(()=>{a.blind=0},5e3)),W.life-=5)}let b=()=>fa(a.pos,ga(a.dir,"e1"===a.sprite?.02:.12)),c=b();da(c.x,c.y)?a.pos=c:(a.dir=ga(a.dir,-1),a.pos=b())}),U.forEach(a=>{let b=fa(a.pos,ga(a.dir,.5));if(da(b.x,b.y))a.pos=b;else return void(a.lifetime=0);T.forEach(b=>{if(a.ownerPlayer&&.5>ea(a.pos,b.pos)){b.life-=15,b.hit=1,0>=b.life&&!Y&&(X=g(r,X+1)),R+=(101-W.life)*S*(Y?2:1);let c=ha(b.pos,ga(a.dir,-.4)),d=1;T.forEach(a=>{b===a||.5>=ea(c,a.pos)&&(d=0)}),da(c.x,c.y)||(d=0),d&&(b.pos=c),a.lifetime=0}}),!Y&&!a.ownerPlayer&&0<a.lifetime&&.5>=ea(a.pos,W.pos)&&(W.life-=2)}),V.forEach(a=>{.5>=ea(a.pos,W.pos)&&"m"===a.sprite&&(W.life=100,a.used=1)}),V=V.filter(a=>!a.used);let e=[],f=[];for(let b=0;b<l;b++){let c,d,f,h,i,n,o=2*b/l-1,p=W.dir.x+$.x*o,q=W.dir.y+$.y*o,r=0|W.pos.x,s=0|W.pos.y,t=j(1/p),u=j(1/q),v=0;for(0>p?(h=-1,c=(W.pos.x-r)*t):(h=1,c=(r+1-W.pos.x)*t),0>q?(i=-1,d=(W.pos.y-s)*u):(i=1,d=(s+1-W.pos.y)*u);!v;)c<d?(c+=t,r+=h,n=0):(d+=u,s+=i,n=1),0<Q[r][s]&&(v=1);f=0===n?(r-W.pos.x+(1-h)/2)/p:(s-W.pos.y+(1-i)/2)/q;let w=0|m/f,x=-w/2+m/2;0>x&&(x=0);let A=w/2+m/2;A>=m&&(A=m-1),x|=0,A|=0;let y;y=0===n?W.pos.y+f*q:W.pos.x+f*p,y-=a(y);let B=0|y*k;0===n&&0<p&&(B=k-B-1),1===n&&0>q&&(B=k-B-1);let C=(A-x)/m,D=g((0|10*C)/10+.2,1);for(let a=x;a<A;a++){let c=256*a-128*m+128*w,d=0|c*k/w/256,e=z[Q[r][s]-1];if(!e[d])continue;let f=g(1,e[d][B]+.5),h=oa(H,D*f);J.fillStyle=na(h),J.fillRect(b,a,1,1)}e[b]=f}let t=[].concat(T,U,V);for(let a=0;a<t.length;a++)f[a]={order:a,distance:(W.pos.x-t[a].pos.x)*(W.pos.x-t[a].pos.x)+(W.pos.y-t[a].pos.y)*(W.pos.y-t[a].pos.y)};f.sort((c,a)=>a.distance-c.distance);for(let a=0;a<t.length;a++){let b=t[f[a].order],c=x[b.sprite],d=b.pos.x-W.pos.x,h=b.pos.y-W.pos.y,i=1/($.x*W.dir.y-W.dir.x*$.y),n=i*(W.dir.y*d-W.dir.x*h),o=i*(-$.y*d+$.x*h),p=0|l/2*(1+n/o),q=0|k/o,r=0|j(0|m/o)/2,s=(0|-r/2+m/2)+q;0>s&&(s=0);let u=(0|r/2+m/2)+q;u>=m&&(u=m-1);let v=0|j(0|m/o)/2,w=0|-v/2+p;0>w&&(w=0);let y=0|v/2+p;y>=l&&(y=l-1);let z=(u-s)/m,A=g(1,(0|10*z)/10+.4),B=oa(I,A);J.fillStyle=b.hit?"white":na(B);for(let a,b=w;b<y;b++)if(a=0|(0|256*(b-(-v/2+p))*k/v)/256,0<o&&0<b&&b<l&&o<e[b])for(let e=s;e<u;e++){let f=256*(e-q)-128*m+128*r,d=0|f*k/r/256;c[d]&&"1"===c[d][a]&&J.fillRect(b,e,1,1)}}let u=d?ta(-2,2):0,v=d?ta(-2,2):0;F.drawImage(G,u,v,360,400),F.fillStyle=na(qa(I)),F.fillRect(10,10,100,10),F.fillStyle=na(I);let w=0|100*(W.life/100);F.fillRect(10,10,w,10),F.fillStyle=na(qa(I)),F.fillRect(10,380,50,10),F.fillStyle=na(I);let y=0|50*(W.gunHeat/o);F.fillRect(10,380,y,10),F.fillStyle=na(I),_(4,a=>ra(280+20*a,370,16,20,F)),_(X,a=>F.fillRect(280+20*a,370,16,20));let B=ga(W.dir,i);if(A.up){let a=fa(W.pos,B);da(a.x,W.pos.y)&&(W.pos.x=a.x),da(W.pos.x,a.y)&&(W.pos.y=a.y)}if(A.down){let a=ha(W.pos,B);da(a.x,W.pos.y)&&(W.pos.x=a.x),da(W.pos.x,a.y)&&(W.pos.y=a.y)}let C=ga({x:-1*W.dir.y,y:W.dir.x},.5*i);if(A.right){let a=ha(W.pos,C);da(a.x,W.pos.y)&&(W.pos.x=a.x),da(W.pos.x,a.y)&&(W.pos.y=a.y)}if(A.left){let a=fa(W.pos,C);da(a.x,W.pos.y)&&(W.pos.x=a.x),da(W.pos.x,a.y)&&(W.pos.y=a.y)}A.special&&X===r&&(Y=1),0>=Z&&Y&&(X--,Z=s,0>=X&&(Y=0));let E=.15*(-A.rotate*.03);if(xa(E),d&&(ya(W.pos,W.dir,1,.1),K=p,!Y&&W.gunHeat--,Ba(.75)),K--,L--,Z--,0>=W.gunHeat&&(W.gunHeatBlock=1),W.gunHeatBlock&&W.gunHeat>=o&&(W.gunHeatBlock=0),W.gunHeat=g(W.gunHeat+.1,o),U=U.map(a=>({...a,lifetime:a.lifetime-1})).filter(a=>0<a.lifetime),T.forEach(a=>{0>=a.life&&5>ta(0,100)&&Aa(a.pos)}),T=T.filter(a=>0<a.life),0>=T.length&&setTimeout(()=>{D=Na(Pa)},2e3),0>=W.life&&(D=Na(Qa)),window.DEBUG_minimap){c.fillStyle="white";for(let a=0;a<n;a++)for(let b=0;b<n;b++)0!==Q[b][a]&&c.fillRect(b,a,1,1);c.fillStyle="yellow",T.forEach(a=>c.fillRect(0|a.pos.x,0|a.pos.y,1,1)),c.fillStyle="red",c.fillRect(0|W.pos.x,0|W.pos.y,1,1)}},Pa=()=>{if(!M){Ca(),Ia();let a=0>=W.life?100:W.life;W=u(),W.life=a,X=0,Y=0,$={...t},Q=La(),S++,M=1}Ka("Shelter Rampage",75,20),0<R&&Ka(`Score: ${R}`,10,150),0>=N&&(Ka("Press FIRE to continue",10,360),A.shoot&&(M=0,N=v,D=Na(Oa))),N--},Qa=()=>{if(!M){let a=localStorage.getItem("hs");(R>a||!a)&&localStorage.setItem("hs",R),M=1}Ka("Game over",120,10),Ka(`Your score is ${R}`,10,100);let a=S-1;Ka(`You've cleared ${a} floor${1==a?"":"s"}`,10,130),Ka(`High score: ${localStorage.getItem("hs")}`,10,190),0>=N&&(Ka("Press FIRE to continue",10,360),A.shoot&&(R=0,S=0,N=v,M=0,D=Na(Pa))),N--};D=Pa,Ma()})();</script>