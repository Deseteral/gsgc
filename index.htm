<style>*{margin:0}#c{image-rendering:pixelated;width:100%;height:100%;}</style><canvas id="c" width="360" height="400"><script>(()=>{let{sin:b,cos:c,floor:a,random:d,sqrt:e,ceil:f,min:g,max:h,abs:j}=Math,k=16,l=90,m=100,n=32,i=.1,o=10,p=7,q=30,r=4,s=30,t={x:.52,y:-.4},u=()=>({dir:{x:.61,y:.79},life:100,gunHeat:o,gunHeatBlock:0}),v=100,w=a=>a.map(a=>parseInt(a,16).toString(2).substr(1).split("")),z=[w(["10000","11ff8","13ffc","17ffe","1700e","1700e","1700e","1700e","1700e","1700e","1700e","1700e","17ffe","13ffc","11ff8","10000"]),w(["10000","1011e","111b7","13d27","11c3f","10e3f","1661e","13000","11000","10000","17ffe","1c7ff","1c7ff","1ffff","17ffe","10000"]),w(["1383c","17c7e","14c4e","14c4e","14c7e","17c7e","17c7e","17c7e","17c3c","17c00","17c3c","17c7e","17c6e","17c5e","17c7e","1383c"])],x={e1:w(["10000","10000","103c0","103c0","10ff0","10ff0","10c30","10c30","10ff0","10ff0","130cc","130cc","133cc","133cc","1c333","1c333"]),e2:w(["10000","10000","10000","10000","10c30","10c30","13ffc","13ffc","103c0","103c0","10ff0","10ff0","10000","10000","10000","10000"]),b:w(["10000","10000","10000","10000","10000","10000","10000","10000","10000","10000","103c0","103c0","103c0","103c0","103c0","103c0"]),m:w(["10000","10000","10000","10000","10000","10000","10000","10000","10ff0","11e78","11e78","11818","11818","11e78","11e78","10ff0"])},y={87:"up",83:"down",65:"left",68:"right",32:"shoot",70:"special",191:"debug"},A={up:0,down:0,left:0,right:0,shoot:0,special:0,debug:0,rotate:0},B=document.addEventListener;B("mousemove",a=>{A.rotate=a.movementX}),B("mousedown",a=>{A.shoot=0===a.button}),B("mouseup",()=>{A.shoot=0}),B("keydown",a=>{A[y[a.keyCode]]=1}),B("keyup",a=>{A[y[a.keyCode]]=0});let C=new AudioContext,D=null,E=document.getElementById("c"),F=E.getContext("2d");F.imageSmoothingEnabled=0,E.onclick=()=>E.requestPointerLock();let G=document.createElement("canvas");G.width=G.height=l;let H,I,J,K=G.getContext("2d"),L=p,M=120,N=0,O=v,P=0,Q=0,R=null,S=0,T=0,U=[],V=[],W=[],X=u(),Y=0,Z=0,$=s,_={...t},aa=(a,b,c=0)=>{for(let d=c;d<a;d++)b(d)},ba=(a,b)=>{let c=[];for(let d=a;d<=b;d++)c.push(d);return c},ca=a=>Array(a).fill([]).map(()=>Array(a).fill(0)),da=b=>{for(let c,e=b.length-1;0<e;e--)c=a(d()*(e+1)),[b[e],b[c]]=[b[c],b[e]]},ea=(a,b)=>0===R[0|a][0|b],fa=(c,a)=>e((a.x-c.x)**2+(a.y-c.y)**2),ga=(c,a)=>({x:c.x+a.x,y:c.y+a.y}),ha=(b,a)=>({x:b.x*a,y:b.y*a}),ia=(c,a)=>ga(c,ha(a,-1)),ja=(b,a)=>({x:b.x/a,y:b.y/a}),ka=b=>e(b.x**2+b.y**2),la=b=>ja(b,ka(b)),ma=(d,a)=>{let e=c(a),f=b(a);return{x:d.x*e-d.y*f,y:d.x*f+d.y*e}},na=(a,b)=>la(ia(b,a)),oa=a=>`rgb(${a.r},${a.g},${a.b})`,pa=(a,b)=>({r:a.r*b,g:a.g*b,b:a.b*b}),qa=a=>({r:-a.r+255,g:-a.g+255,b:-a.b+255}),ra=a=>pa(a,.5),sa=(a,b,c,d,e)=>{e.fillRect(a,b,c,1),e.fillRect(a,b+d,c,1),e.fillRect(a,b,1,d),e.fillRect(a+c,b,1,d)},ta=(a,b)=>d()*(b-a)+a,ua=(b,c)=>(b=f(b),c=a(c),a(d()*(c-b+1))+b),va=()=>la({x:ta(-1,1),y:ta(-1,1)}),wa=()=>ua(120,360),xa=(a,b)=>{if(!b&&(a.blind||0<M||10<fa(a.pos,X.pos)))return 0;let c=na(a.pos,X.pos),d={...a.pos},e=0;for(;;){if(.5>=fa(d,X.pos)){e=1;break}if(!ea(d.x,d.y))break;d=ga(d,c)}return e},ya=a=>{let d=X.dir.x;X.dir.x=X.dir.x*c(a)-X.dir.y*b(a),X.dir.y=d*b(a)+X.dir.y*c(a);let e=_.x;_.x=_.x*c(a)-_.y*b(a),_.y=e*b(a)+_.y*c(a)},za=(a,b,c,d)=>{V.push({sprite:"b",pos:{...a},dir:ma(b,ta(-d,d)),lifetime:180,ownerPlayer:c})},Aa=(a,b)=>{U.push({sprite:a,pos:b,dir:va(),changeDirTimer:wa(),life:100,shootingFrameTimeout:q})},Ba=a=>{W.push({sprite:"m",pos:a})},Ca=a=>1/h(a,1),Da=(a,b,c)=>{let d=C.createOscillator(),e=C.createGain();d.type=a,d.frequency.value=b,d.connect(e),e.connect(C.destination),e.gain.setValueAtTime(c,C.currentTime),e.gain.setTargetAtTime(0,C.currentTime,.05),d.start()},Ea=a=>Da("triangle",ua(90,92),Ca(a)),Fa=()=>Da("sawtooth",25,.75),Ga=a=>Da("triangle",ua(148,152),2*Ca(a)),Ha=()=>{I={r:ua(30,255),g:ua(30,255),b:ua(30,255)},J=qa(I)};Ha();let Ia=24,Ja=48,Ka={},La={},Ma=(a,b)=>{ba(32,126).map(b=>String.fromCharCode(b)).forEach(d=>{let e=document.createElement("canvas");e.width=Ja,e.height=Ja;let c=e.getContext("2d");c.font=`${Ia}px monospace`,c.fillStyle=a,c.fillText(d,0,Ia);let f=c.getImageData(0,0,Ja,Ja).data;for(let a=0;a<f.length;a+=4)if(0!==f[a]||0!==f[a+1]||0!==f[a+2]){let b=0|a/4;c.fillRect(0|b%Ja,0|b/Ja,1,1)}b[d]=e})},Na=()=>{Ma(oa(I),Ka),Ma(oa(J),La)};Na();let Oa=(a,b,c,d)=>{a.split("").forEach((a,e)=>{F.drawImage(d[a],b+e*14,c)})},Pa=(a,b,c)=>{aa(ua(2,4),()=>{let d=ua(-2,2),e=ua(-2,2);Oa(a,b+d,c+e,La)}),Oa(a,b,c,Ka)},Qa=()=>{let a=()=>{let a=ca(n),b=(b,c)=>{let d=0;return[-1,0,1].forEach(e=>{[-1,0,1].forEach(f=>{if(0===e&&0===f)return;let g=b+e,h=c+f;(0>g||0>h||g>=n||h>=n||a[g][h])&&d++})}),d};return aa(n,b=>{aa(n,c=>{a[c][b]=d()<.49?1:0})}),aa(10,()=>{let c=ca(n);aa(n,d=>{aa(n,e=>{let f=b(e,d);c[e][d]=a[e][d]?f<4?0:1:f>5?1:0})}),a=c}),a[0]=Array(n).fill(1),a[n-1]=Array(n).fill(1),a.forEach(a=>{a[0]=1,a[n-1]=1}),a},b=a();for(;0!==b[n/2][n/2];)b=a();(a=>{let b=ca(n),c=[];b[n/2][n/2]=1,c.push({x:n/2,y:n/2});for(let d=({x:d,y:e})=>{[-1,0,1].forEach(f=>{[-1,0,1].forEach(g=>{if(0!==f&&0!==g)return;let h=d+f,i=e+g;0<=h&&0<=i&&h<n&&i<n&&0===a[h][i]&&0===b[h][i]&&(b[h][i]=1,c.push({x:h,y:i}))})})};c.length;)d(c.shift());aa(n,c=>{aa(n,d=>{0===a[d][c]&&0===b[d][c]&&(a[d][c]=1)})})})(b),aa(n,a=>{aa(n,c=>{b[c][a]&&(b[c][a]=ua(1,z.length))})});let c=[],e=0;aa(n,a=>{aa(n,d=>{0===b[d][a]&&(e?c.push({x:d,y:a}):(X.pos={x:d+.1,y:a+.1},e=1))},1)},1),da(c);let f=()=>{let a=c.pop();for(;15>=fa(a,X.pos);)a=c.pop();return a};return aa(3<T?1:0,()=>{let a=c.pop();Ba(a)}),aa(g(20,ua(1*(T||1),5*(T||1))),()=>Aa("e1",f())),aa(g(5,T),()=>Aa("e2",f())),b};{let a=document.createElement("canvas");a.id="minimap",a.width=32,a.height=32,a.style.position="absolute",a.style.width="256px",a.style["image-rendering"]="pixelated",document.body.insertBefore(a,document.body.firstChild),window.minimap=a}let Ra=()=>{if(A.debug&&(window.DEBUG=1),P||(F.fillStyle="black",F.fillRect(0,0,360,400)),D(),window.DEBUG){let a={},b=F.getImageData(0,0,360,400).data;for(let c,d=0;d<b.length;d+=4){if(c=oa({r:b[d],g:b[d+1],b:b[d+2]}),255!==b[d+3])throw new Error("Alpha is not 255!");a[c]=1}let c=Object.keys(a).length,d=32<c?"error":"log";console[d](`Distinct colors in frame: ${c}`)}A.rotate=0,window.DEBUG=0,window.requestAnimationFrame(Ra)},Sa=0,Ta=a=>()=>{P=1,Sa||(H=C.createOscillator(),H.type="sine",H.frequency.value=130,H.connect(C.destination),H.start()),Sa=1,F.fillStyle=oa(I);for(let a=0;400>a;a+=40)F.fillRect(0,a,Q,20);for(let a=20;400>a;a+=40)F.fillRect(360-Q,a,Q,20);Q+=5,H.frequency.value=130+Q/360*131,360<Q&&setTimeout(()=>{P=0,Q=0,H.stop(),Sa=0,D=a},300)},Ua=()=>{let{minimap:b}=window,c=b.getContext("2d");c.imageSmoothingEnabled=0,b.style.display=window.DEBUG_minimap?"block":"none",K.fillStyle="black",K.fillRect(0,0,l,m),c.fillStyle="black",c.fillRect(0,0,n,n);let d=A.shoot&&(Z||0>=L)&&!X.gunHeatBlock;U.forEach(a=>{if(a.hit=0,a.shootingFrameTimeout--,a.changeDirTimer--,0>=a.changeDirTimer&&(a.dir=va(),a.changeDirTimer=wa()),"e1"===a.sprite&&U.forEach(b=>{b===a||.5>=fa(a.pos,b.pos)&&(a.dir=ha(a.dir,-1))}),xa(a,d)){let b=na(a.pos,X.pos);if(a.dir=b,"e1"===a.sprite){let c=fa(X.pos,a.pos);3>=c&&(a.dir=ha(la(na(a.pos,X.pos)),-3)),0>=a.shootingFrameTimeout&&(za(a.pos,b,0,.2),a.shootingFrameTimeout=q,Ea(c))}.5>=fa(a.pos,X.pos)&&("e1"===a.sprite?a.life=0:(a.dir=ha(a.dir,-1),a.blind=1,setTimeout(()=>{a.blind=0},5e3)),X.life-=5,Fa())}let b=()=>ga(a.pos,ha(a.dir,"e1"===a.sprite?.02:.12)),c=b();ea(c.x,c.y)?a.pos=c:(a.dir=ha(a.dir,-1),a.pos=b())}),V.forEach(a=>{let b=ga(a.pos,ha(a.dir,.5));if(ea(b.x,b.y))a.pos=b;else return void(a.lifetime=0);U.forEach(b=>{if(a.ownerPlayer&&.5>fa(a.pos,b.pos)){b.life-=15,b.hit=1,0>=b.life&&!Z&&(Y=g(r,Y+1)),S+=(101-X.life)*T*(Z?2:1);let c=ia(b.pos,ha(a.dir,-.4)),d=1;U.forEach(a=>{b===a||.5>=fa(c,a.pos)&&(d=0)}),ea(c.x,c.y)||(d=0),d&&(b.pos=c),a.lifetime=0,Ga(fa(b.pos,X.pos))}}),!Z&&!a.ownerPlayer&&0<a.lifetime&&.5>=fa(a.pos,X.pos)&&(X.life-=2,Fa())}),W.forEach(a=>{.5>=fa(a.pos,X.pos)&&"m"===a.sprite&&(X.life=100,a.used=1)}),W=W.filter(a=>!a.used);let e=[],f=[];for(let b=0;b<l;b++){let c,d,f,h,i,n,o=2*b/l-1,p=X.dir.x+_.x*o,q=X.dir.y+_.y*o,r=0|X.pos.x,s=0|X.pos.y,t=j(1/p),u=j(1/q),v=0;for(0>p?(h=-1,c=(X.pos.x-r)*t):(h=1,c=(r+1-X.pos.x)*t),0>q?(i=-1,d=(X.pos.y-s)*u):(i=1,d=(s+1-X.pos.y)*u);!v;)c<d?(c+=t,r+=h,n=0):(d+=u,s+=i,n=1),0<R[r][s]&&(v=1);f=0===n?(r-X.pos.x+(1-h)/2)/p:(s-X.pos.y+(1-i)/2)/q;let w=0|m/f,x=-w/2+m/2;0>x&&(x=0);let A=w/2+m/2;A>=m&&(A=m-1),x|=0,A|=0;let y;y=0===n?X.pos.y+f*q:X.pos.x+f*p,y-=a(y);let B=0|y*k;0===n&&0<p&&(B=k-B-1),1===n&&0>q&&(B=k-B-1);let C=(A-x)/m,D=g((0|10*C)/10+.2,1);for(let a=x;a<A;a++){let c=256*a-128*m+128*w,d=0|c*k/w/256,e=z[R[r][s]-1];if(!e[d])continue;let f=g(1,e[d][B]+.5),h=pa(I,D*f);K.fillStyle=oa(h),K.fillRect(b,a,1,1)}e[b]=f}let h=[].concat(U,V,W);for(let a=0;a<h.length;a++)f[a]={order:a,distance:(X.pos.x-h[a].pos.x)*(X.pos.x-h[a].pos.x)+(X.pos.y-h[a].pos.y)*(X.pos.y-h[a].pos.y)};f.sort((c,a)=>a.distance-c.distance);for(let a=0;a<h.length;a++){let b=h[f[a].order],c=x[b.sprite],d=b.pos.x-X.pos.x,i=b.pos.y-X.pos.y,n=1/(_.x*X.dir.y-X.dir.x*_.y),o=n*(X.dir.y*d-X.dir.x*i),p=n*(-_.y*d+_.x*i),q=0|l/2*(1+o/p),r=0|k/p,s=0|j(0|m/p)/2,t=(0|-s/2+m/2)+r;0>t&&(t=0);let u=(0|s/2+m/2)+r;u>=m&&(u=m-1);let v=0|j(0|m/p)/2,w=0|-v/2+q;0>w&&(w=0);let y=0|v/2+q;y>=l&&(y=l-1);let z=(u-t)/m,A=g(1,(0|10*z)/10+.4),B=pa(J,A);K.fillStyle=b.hit?"white":oa(B);for(let a,b=w;b<y;b++)if(a=0|(0|256*(b-(-v/2+q))*k/v)/256,0<p&&0<b&&b<l&&p<e[b])for(let e=t;e<u;e++){let f=256*(e-r)-128*m+128*s,d=0|f*k/s/256;c[d]&&"1"===c[d][a]&&K.fillRect(b,e,1,1)}}let t=d?ua(-2,2):0,u=d?ua(-2,2):0;F.drawImage(G,t,u,360,400),F.fillStyle=oa(ra(J)),F.fillRect(10,10,100,10),F.fillStyle=oa(J);let v=0|100*(X.life/100);F.fillRect(10,10,v,10),F.fillStyle=oa(ra(J)),F.fillRect(10,380,50,10),F.fillStyle=oa(J);let w=0|50*(X.gunHeat/o);F.fillRect(10,380,w,10),F.fillStyle=oa(J),aa(4,a=>sa(280+20*a,370,16,20,F)),aa(Y,a=>F.fillRect(280+20*a,370,16,20));let y=ha(X.dir,i);if(A.up){let a=ga(X.pos,y);ea(a.x,X.pos.y)&&(X.pos.x=a.x),ea(X.pos.x,a.y)&&(X.pos.y=a.y)}if(A.down){let a=ia(X.pos,y);ea(a.x,X.pos.y)&&(X.pos.x=a.x),ea(X.pos.x,a.y)&&(X.pos.y=a.y)}let B=ha({x:-1*X.dir.y,y:X.dir.x},.5*i);if(A.right){let a=ia(X.pos,B);ea(a.x,X.pos.y)&&(X.pos.x=a.x),ea(X.pos.x,a.y)&&(X.pos.y=a.y)}if(A.left){let a=ga(X.pos,B);ea(a.x,X.pos.y)&&(X.pos.x=a.x),ea(X.pos.x,a.y)&&(X.pos.y=a.y)}A.special&&Y===r&&(Z=1),0>=$&&Z&&(Y--,$=s,0>=Y&&(Z=0));let C=.15*(-A.rotate*.03);if(ya(C),d&&(za(X.pos,X.dir,1,.1),L=p,!Z&&X.gunHeat--,Ea(1)),L--,M--,$--,0>=X.gunHeat&&(X.gunHeatBlock=1),X.gunHeatBlock&&X.gunHeat>=o&&(X.gunHeatBlock=0),X.gunHeat=g(X.gunHeat+.1,o),V=V.map(a=>({...a,lifetime:a.lifetime-1})).filter(a=>0<a.lifetime),U.forEach(a=>{0>=a.life&&5>ua(0,100)&&Ba(a.pos)}),U=U.filter(a=>0<a.life),0>=U.length&&setTimeout(()=>{D=Ta(Va)},2e3),0>=X.life&&(D=Ta(Wa)),window.DEBUG_minimap){c.fillStyle="white";for(let a=0;a<n;a++)for(let b=0;b<n;b++)0!==R[b][a]&&c.fillRect(b,a,1,1);c.fillStyle="yellow",U.forEach(a=>c.fillRect(0|a.pos.x,0|a.pos.y,1,1)),c.fillStyle="red",c.fillRect(0|X.pos.x,0|X.pos.y,1,1)}},Va=()=>{if(!N){Ha(),Na();let a=0>=X.life?100:X.life;X=u(),X.life=a,Y=0,Z=0,_={...t},R=Qa(),T++,N=1}Pa("Shelter Rampage",75,20),0<S&&Pa(`Score: ${S}`,10,150),0>=O&&(Pa("Press FIRE to continue",10,360),A.shoot&&(N=0,O=v,D=Ta(Ua))),O--},Wa=()=>{if(!N){let a=localStorage.getItem("hs");(S>a||!a)&&localStorage.setItem("hs",S),N=1}Pa("Game over",120,10),Pa(`Your score is ${S}`,10,100);let a=T-1;Pa(`You've cleared ${a} floor${1==a?"":"s"}`,10,130),Pa(`High score: ${localStorage.getItem("hs")}`,10,190),0>=O&&(Pa("Press FIRE to continue",10,360),A.shoot&&(S=0,T=0,O=v,N=0,D=Ta(Va))),O--};D=Va,Ra()})();</script>