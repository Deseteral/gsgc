<style>*{margin:0}#c{image-rendering:pixelated;width:100%;height:100%;}</style><canvas id="c" width="360" height="400"><script>(()=>{let{sin:b,cos:c,floor:a,random:d,sqrt:e,ceil:f,min:g,max:h,abs:j}=Math,i=["May 5th, 2143","","You have been sent to","investigate what happend","in the Shelter A142.","","Your task is simple -","find and kill any enemy","forces that occupy","the shelter.","","Beware!","That shelter is very","deep and we've got","no intel about what's","inside it."],k=16,l=90,m=100,n=32,o=.1,p=10,q=7,r=30,s=4,t=30,u={x:.52,y:-.4},v=()=>({dir:{x:.61,y:.79},life:100,gunHeat:p,gunHeatBlock:0}),w=100,x=a=>a.map(a=>parseInt(a,16).toString(2).substr(1).split("")),z=[x(["10000","11ff8","13ffc","17ffe","1700e","1700e","1700e","1700e","1700e","1700e","1700e","1700e","17ffe","13ffc","11ff8","10000"]),x(["10000","1011e","111b7","13d27","11c3f","10e3f","1661e","13000","11000","10000","17ffe","1c7ff","1c7ff","1ffff","17ffe","10000"]),x(["1383c","17c7e","14c4e","14c4e","14c7e","17c7e","17c7e","17c7e","17c3c","17c00","17c3c","17c7e","17c6e","17c5e","17c7e","1383c"])],y={e1:x(["10000","10000","103c0","103c0","10ff0","10ff0","10c30","10c30","10ff0","10ff0","130cc","130cc","133cc","133cc","1c333","1c333"]),e2:x(["10000","10000","10000","10000","10c30","10c30","13ffc","13ffc","103c0","103c0","10ff0","10ff0","10000","10000","10000","10000"]),b:x(["10000","10000","10000","10000","10000","10000","10000","10000","10000","10000","103c0","103c0","103c0","103c0","103c0","103c0"]),m:x(["10000","10000","10000","10000","10000","10000","10000","10000","10ff0","11e78","11e78","11818","11818","11e78","11e78","10ff0"])},A={87:"up",83:"down",65:"left",68:"right",32:"shoot",70:"special",191:"debug"},B={up:0,down:0,left:0,right:0,shoot:0,special:0,debug:0,rotate:0},C=document.addEventListener;C("mousemove",a=>{B.rotate=a.movementX}),C("mousedown",a=>{B.shoot=0===a.button}),C("mouseup",()=>{B.shoot=0}),C("keydown",a=>{B[A[a.keyCode]]=1}),C("keyup",a=>{B[A[a.keyCode]]=0});let D=new AudioContext,E=null,F=document.getElementById("c"),G=F.getContext("2d");G.imageSmoothingEnabled=0,F.onclick=()=>F.requestPointerLock();let H=document.createElement("canvas");H.width=H.height=l;let I,J,K,L=H.getContext("2d"),M=q,N=120,O=0,P=w,Q=0,R=0,S=null,T=0,U=0,V=[],W=[],X=[],Y=v(),Z=0,$=0,_=t,aa={...u},ba=(a,b,c=0)=>{for(let d=c;d<a;d++)b(d)},ca=(a,b)=>{let c=[];for(let d=a;d<=b;d++)c.push(d);return c},da=a=>Array(a).fill([]).map(()=>Array(a).fill(0)),ea=b=>{for(let c,e=b.length-1;0<e;e--)c=a(d()*(e+1)),[b[e],b[c]]=[b[c],b[e]]},fa=(a,b)=>0===S[0|a][0|b],ga=(c,a)=>e((a.x-c.x)**2+(a.y-c.y)**2),ha=(c,a)=>({x:c.x+a.x,y:c.y+a.y}),ia=(b,a)=>({x:b.x*a,y:b.y*a}),ja=(c,a)=>ha(c,ia(a,-1)),ka=(b,a)=>({x:b.x/a,y:b.y/a}),la=b=>e(b.x**2+b.y**2),ma=b=>ka(b,la(b)),na=(d,a)=>{let e=c(a),f=b(a);return{x:d.x*e-d.y*f,y:d.x*f+d.y*e}},oa=(a,b)=>ma(ja(b,a)),pa=a=>`rgb(${a.r},${a.g},${a.b})`,qa=(a,b)=>({r:a.r*b,g:a.g*b,b:a.b*b}),ra=a=>({r:-a.r+255,g:-a.g+255,b:-a.b+255}),sa=a=>qa(a,.5),ta=(a,b,c,d,e)=>{e.fillRect(a,b-1,c,2),e.fillRect(a,b+d,c,2),e.fillRect(a-1,b,2,d),e.fillRect(a+c,b,2,d)},ua=(a,b)=>d()*(b-a)+a,va=(b,c)=>(b=f(b),c=a(c),a(d()*(c-b+1))+b),wa=()=>ma({x:ua(-1,1),y:ua(-1,1)}),xa=()=>va(120,360),ya=(a,b)=>{if(!b&&(a.blind||0<N||10<ga(a.pos,Y.pos)))return 0;let c=oa(a.pos,Y.pos),d={...a.pos},e=0;for(;;){if(.5>=ga(d,Y.pos)){e=1;break}if(!fa(d.x,d.y))break;d=ha(d,c)}return e},za=a=>{let d=Y.dir.x;Y.dir.x=Y.dir.x*c(a)-Y.dir.y*b(a),Y.dir.y=d*b(a)+Y.dir.y*c(a);let e=aa.x;aa.x=aa.x*c(a)-aa.y*b(a),aa.y=e*b(a)+aa.y*c(a)},Aa=(a,b,c,d)=>{W.push({sprite:"b",pos:{...a},dir:na(b,ua(-d,d)),lifetime:180,ownerPlayer:c})},Ba=(a,b)=>{V.push({sprite:a,pos:b,dir:wa(),changeDirTimer:xa(),life:100,shootingFrameTimeout:r})},Ca=a=>{X.push({sprite:"m",pos:a})},Da=a=>1/h(a,1),Ea=(a,b,c)=>{let d=D.createOscillator(),e=D.createGain();d.type=a,d.frequency.value=b,d.connect(e),e.connect(D.destination),e.gain.setValueAtTime(c,D.currentTime),e.gain.setTargetAtTime(0,D.currentTime,.05),d.start(),d.stop(D.currentTime+1)},Fa=a=>Ea("triangle",va(90,92),Da(a)),Ga=()=>Ea("sawtooth",25,.75),Ha=a=>Ea("triangle",va(148,152),2*Da(a)),Ia=a=>Ea("sawtooth",10*Da(a),3*Da(a)),Ja=()=>{J={r:va(30,255),g:va(30,255),b:va(30,255)},K=ra(J)};Ja();let Ka=24,La=48,Ma={},Na={},Oa=(a,b)=>{ca(32,126).map(b=>String.fromCharCode(b)).forEach(d=>{let e=document.createElement("canvas");e.width=La,e.height=La;let c=e.getContext("2d");c.font=`${Ka}px monospace`,c.fillStyle=a,c.fillText(d,0,Ka);let f=c.getImageData(0,0,La,La).data;for(let a=0;a<f.length;a+=4)if(0!==f[a]||0!==f[a+1]||0!==f[a+2]){let b=0|a/4;c.fillRect(0|b%La,0|b/La,1,1)}b[d]=e})},Pa=()=>{Oa(pa(J),Ma),Oa(pa(K),Na)};Pa();let Qa=(a,b,c,d)=>{a.split("").forEach((a,e)=>{G.drawImage(d[a],b+e*14,c)})},Ra=(a,b,c)=>{ba(va(2,4),()=>{let d=va(-2,2),e=va(-2,2);Qa(a,b+d,c+e,Na)}),Qa(a,b,c,Ma)},Sa=()=>{let a=()=>{let a=da(n),b=(b,c)=>{let d=0;return[-1,0,1].forEach(e=>{[-1,0,1].forEach(f=>{if(0===e&&0===f)return;let g=b+e,h=c+f;(0>g||0>h||g>=n||h>=n||a[g][h])&&d++})}),d};return ba(n,b=>{ba(n,c=>{a[c][b]=d()<.49?1:0})}),ba(10,()=>{let c=da(n);ba(n,d=>{ba(n,e=>{let f=b(e,d);c[e][d]=a[e][d]?f<4?0:1:f>5?1:0})}),a=c}),a[0]=Array(n).fill(1),a[n-1]=Array(n).fill(1),a.forEach(a=>{a[0]=1,a[n-1]=1}),a},b=a();for(;0!==b[n/2][n/2];)b=a();(a=>{let b=da(n),c=[];b[n/2][n/2]=1,c.push({x:n/2,y:n/2});for(let d=({x:d,y:e})=>{[-1,0,1].forEach(f=>{[-1,0,1].forEach(g=>{if(0!==f&&0!==g)return;let h=d+f,i=e+g;0<=h&&0<=i&&h<n&&i<n&&0===a[h][i]&&0===b[h][i]&&(b[h][i]=1,c.push({x:h,y:i}))})})};c.length;)d(c.shift());ba(n,c=>{ba(n,d=>{0===a[d][c]&&0===b[d][c]&&(a[d][c]=1)})})})(b),ba(n,a=>{ba(n,c=>{b[c][a]&&(b[c][a]=va(1,z.length))})});let c=[],e=0;ba(n,a=>{ba(n,d=>{0===b[d][a]&&(e?c.push({x:d,y:a}):(Y.pos={x:d+.1,y:a+.1},e=1))},1)},1),ea(c);let f=()=>{let a=c.pop();for(;15>=ga(a,Y.pos);)a=c.pop();return a};return ba(3<U?1:0,()=>{let a=c.pop();Ca(a)}),W=[],V=[],X=[],ba(2,()=>Ba("e2",f())),b};{let a=document.createElement("canvas");a.id="minimap",a.width=32,a.height=32,a.style.position="absolute",a.style.width="256px",a.style["image-rendering"]="pixelated",document.body.insertBefore(a,document.body.firstChild),window.minimap=a}let Ta=()=>{if(B.debug&&(window.DEBUG=1),Q||(G.fillStyle="black",G.fillRect(0,0,360,400)),E(),window.DEBUG){let a={},b=G.getImageData(0,0,360,400).data;for(let c,d=0;d<b.length;d+=4){if(c=pa({r:b[d],g:b[d+1],b:b[d+2]}),255!==b[d+3])throw new Error("Alpha is not 255!");a[c]=1}let c=Object.keys(a).length,d=32<c?"error":"log";console[d](`Distinct colors in frame: ${c}`)}B.rotate=0,window.DEBUG=0,window.requestAnimationFrame(Ta)},Ua=0,Va=a=>()=>{Q=1,Ua||(I=D.createOscillator(),I.type="sine",I.frequency.value=130,I.connect(D.destination),I.start()),Ua=1,G.fillStyle=pa(J);for(let a=0;400>a;a+=40)G.fillRect(0,a,R,20);for(let a=20;400>a;a+=40)G.fillRect(360-R,a,R,20);R+=5,I.frequency.value=130+R/360*131,360<R&&setTimeout(()=>{Q=0,R=0,I.stop(),Ua=0,E=a},500)},Wa=()=>{let{minimap:b}=window,c=b.getContext("2d");c.imageSmoothingEnabled=0,b.style.display=window.DEBUG_minimap?"block":"none",L.fillStyle="black",L.fillRect(0,0,l,m),c.fillStyle="black",c.fillRect(0,0,n,n);let d=B.shoot&&($||0>=M)&&!Y.gunHeatBlock;V.forEach(a=>{if(a.hit=0,a.shootingFrameTimeout--,a.changeDirTimer--,0>=a.changeDirTimer&&(a.dir=wa(),a.changeDirTimer=xa()),Ia(ga(a.pos,Y.pos)),"e1"===a.sprite&&V.forEach(b=>{b===a||.5>=ga(a.pos,b.pos)&&(a.dir=ia(a.dir,-1))}),ya(a,d)){let b=oa(a.pos,Y.pos);if(a.dir=b,"e1"===a.sprite){let c=ga(Y.pos,a.pos);3>=c&&(a.dir=ia(ma(oa(a.pos,Y.pos)),-3)),0>=a.shootingFrameTimeout&&(Aa(a.pos,b,0,.2),a.shootingFrameTimeout=r,Fa(c))}.5>=ga(a.pos,Y.pos)&&("e1"===a.sprite?a.life=0:(a.dir=ia(a.dir,-1),a.blind=1,setTimeout(()=>{a.blind=0},5e3)),Y.life-=5,Ga())}let b=()=>ha(a.pos,ia(a.dir,"e1"===a.sprite?.02:.12)),c=b();fa(c.x,c.y)?a.pos=c:(a.dir=ia(a.dir,-1),a.pos=b())}),W.forEach(a=>{let b=ha(a.pos,ia(a.dir,.5));if(fa(b.x,b.y))a.pos=b;else return void(a.lifetime=0);V.forEach(b=>{if(a.ownerPlayer&&.5>ga(a.pos,b.pos)){b.life-=15,b.hit=1,0>=b.life&&!$&&(Z=g(s,Z+1)),T+=(101-Y.life)*U*($?2:1);let c=ja(b.pos,ia(a.dir,-.4)),d=1;V.forEach(a=>{b===a||.5>=ga(c,a.pos)&&(d=0)}),fa(c.x,c.y)||(d=0),d&&(b.pos=c),a.lifetime=0,Ha(ga(b.pos,Y.pos))}}),!$&&!a.ownerPlayer&&0<a.lifetime&&.5>=ga(a.pos,Y.pos)&&(Y.life-=2,Ga())}),X.forEach(a=>{.5>=ga(a.pos,Y.pos)&&"m"===a.sprite&&(Y.life=100,a.used=1)}),X=X.filter(a=>!a.used);let e=[],f=[];for(let b=0;b<l;b++){let c,d,f,h,i,n,o=2*b/l-1,p=Y.dir.x+aa.x*o,q=Y.dir.y+aa.y*o,r=0|Y.pos.x,s=0|Y.pos.y,t=j(1/p),u=j(1/q),v=0;for(0>p?(h=-1,c=(Y.pos.x-r)*t):(h=1,c=(r+1-Y.pos.x)*t),0>q?(i=-1,d=(Y.pos.y-s)*u):(i=1,d=(s+1-Y.pos.y)*u);!v;)c<d?(c+=t,r+=h,n=0):(d+=u,s+=i,n=1),0<S[r][s]&&(v=1);f=0===n?(r-Y.pos.x+(1-h)/2)/p:(s-Y.pos.y+(1-i)/2)/q;let w=0|m/f,x=-w/2+m/2;0>x&&(x=0);let A=w/2+m/2;A>=m&&(A=m-1),x|=0,A|=0;let y;y=0===n?Y.pos.y+f*q:Y.pos.x+f*p,y-=a(y);let B=0|y*k;0===n&&0<p&&(B=k-B-1),1===n&&0>q&&(B=k-B-1);let C=(A-x)/m,D=g((0|10*C)/10+.2,1);for(let a=x;a<A;a++){let c=256*a-128*m+128*w,d=0|c*k/w/256,e=z[S[r][s]-1];if(!e[d])continue;let f=g(1,e[d][B]+.5),h=qa(J,D*f);L.fillStyle=pa(h),L.fillRect(b,a,1,1)}e[b]=f}let h=[].concat(V,W,X);for(let a=0;a<h.length;a++)f[a]={order:a,distance:(Y.pos.x-h[a].pos.x)*(Y.pos.x-h[a].pos.x)+(Y.pos.y-h[a].pos.y)*(Y.pos.y-h[a].pos.y)};f.sort((c,a)=>a.distance-c.distance);for(let a=0;a<h.length;a++){let b=h[f[a].order],c=y[b.sprite],d=b.pos.x-Y.pos.x,i=b.pos.y-Y.pos.y,n=1/(aa.x*Y.dir.y-Y.dir.x*aa.y),o=n*(Y.dir.y*d-Y.dir.x*i),p=n*(-aa.y*d+aa.x*i),q=0|l/2*(1+o/p),r=0|k/p,s=0|j(0|m/p)/2,t=(0|-s/2+m/2)+r;0>t&&(t=0);let u=(0|s/2+m/2)+r;u>=m&&(u=m-1);let v=0|j(0|m/p)/2,w=0|-v/2+q;0>w&&(w=0);let x=0|v/2+q;x>=l&&(x=l-1);let z=(u-t)/m,A=g(1,(0|10*z)/10+.4),B=qa(K,A);L.fillStyle=b.hit?"white":pa(B);for(let a,b=w;b<x;b++)if(a=0|(0|256*(b-(-v/2+q))*k/v)/256,0<p&&0<b&&b<l&&p<e[b])for(let e=t;e<u;e++){let f=256*(e-r)-128*m+128*s,d=0|f*k/s/256;c[d]&&"1"===c[d][a]&&L.fillRect(b,e,1,1)}}let i=d?va(-2,2):0,u=d?va(-2,2):0;G.drawImage(H,i,u,360,400),G.fillStyle=pa(sa(K)),G.fillRect(10,10,100,10),G.fillStyle=pa(K);let v=0|100*(Y.life/100);G.fillRect(10,10,v,10),G.fillStyle=pa(sa(K)),G.fillRect(10,380,50,10),G.fillStyle=pa(K);let w=0|50*(Y.gunHeat/p);G.fillRect(10,380,w,10),G.fillStyle=pa(K),ba(4,a=>ta(280+20*a,370,16,20,G)),ba(Z,a=>G.fillRect(280+20*a,370,16,20));let x=ia(Y.dir,o);if(B.up){let a=ha(Y.pos,x);fa(a.x,Y.pos.y)&&(Y.pos.x=a.x),fa(Y.pos.x,a.y)&&(Y.pos.y=a.y)}if(B.down){let a=ja(Y.pos,x);fa(a.x,Y.pos.y)&&(Y.pos.x=a.x),fa(Y.pos.x,a.y)&&(Y.pos.y=a.y)}let A=ia({x:-1*Y.dir.y,y:Y.dir.x},.5*o);if(B.right){let a=ja(Y.pos,A);fa(a.x,Y.pos.y)&&(Y.pos.x=a.x),fa(Y.pos.x,a.y)&&(Y.pos.y=a.y)}if(B.left){let a=ha(Y.pos,A);fa(a.x,Y.pos.y)&&(Y.pos.x=a.x),fa(Y.pos.x,a.y)&&(Y.pos.y=a.y)}B.special&&Z===s&&($=1),0>=_&&$&&(Z--,_=t,0>=Z&&($=0));let C=.15*(-B.rotate*.03);if(za(C),d&&(Aa(Y.pos,Y.dir,1,.1),M=q,!$&&Y.gunHeat--,Fa(1)),M--,N--,_--,0>=Y.gunHeat&&(Y.gunHeatBlock=1),Y.gunHeatBlock&&Y.gunHeat>=p&&(Y.gunHeatBlock=0),Y.gunHeat=g(Y.gunHeat+.1,p),W=W.map(a=>({...a,lifetime:a.lifetime-1})).filter(a=>0<a.lifetime),V.forEach(a=>{0>=a.life&&5>va(0,100)&&Ca(a.pos)}),V=V.filter(a=>0<a.life),0>=V.length&&setTimeout(()=>{E=Va(Xa)},2e3),0>=Y.life&&(E=Va(Ya)),window.DEBUG_minimap){c.fillStyle="white";for(let a=0;a<n;a++)for(let b=0;b<n;b++)0!==S[b][a]&&c.fillRect(b,a,1,1);c.fillStyle="yellow",V.forEach(a=>c.fillRect(0|a.pos.x,0|a.pos.y,1,1)),c.fillStyle="red",c.fillRect(0|Y.pos.x,0|Y.pos.y,1,1)}},Xa=()=>{if(!O){Ja(),Pa();let a=0>=Y.life?100:Y.life;Y=v(),Y.life=a,Z=0,$=0,aa={...u},S=Sa(),U++,O=1}Ra("Shelter Rampage",75,20),0<T&&Ra(`Score: ${T}`,10,150),0>=P&&(Ra("Press FIRE to continue",10,360),B.shoot&&(O=0,P=w,E=Va(Wa))),P--},Ya=()=>{if(!O){let a=localStorage.getItem("hs");(T>a||!a)&&localStorage.setItem("hs",T),O=1}Ra("Game over",120,10),Ra(`Your score is ${T}`,10,100);let a=U-1;Ra(`You've cleared ${a} floor${1==a?"":"s"}`,10,130),Ra(`High score: ${localStorage.getItem("hs")}`,10,190),0>=P&&(Ra("Press FIRE to continue",10,360),B.shoot&&(T=0,U=0,P=w,O=0,E=Va(Xa))),P--};E=()=>{ba(i.length,a=>{Qa(i[a],10,10+22*a,Ma)}),B.shoot&&(E=Va(Xa))},Ta()})();</script>